# MAX TrustLine Bot
Анонимная линия доверия, реализованния в виде чат-бота в национальном мессенджере MAX
Единый канал приёма и обработки сообщений о нарушениях для ТСЖ, вузов и органов власти

## Требования
- Node.js 20+ и npm 10+ (см. `requirements.txt` для полного списка библиотек и версий).
- Доступный по HTTPS URL, на который MAX сможет слать вебхук (`WEBHOOK_URL`).
- Токен бота MAX (`BOT_TOKEN`) и, по желанию, секрет подписи (`WEBHOOK_SECRET`).
- Docker 24+ (если планируете контейнеризацию).

## Конфигурация
1. Скопируйте пример переменных:
   ```bash
   cp .env.example .env
   ```
2. Заполните `.env`:
   - `BOT_TOKEN` — токен из кабинета MAX.
   - `WEBHOOK_URL` — публичный `https://.../webhook/max`.
   - `WEBHOOK_SECRET` — строка для проверки подписи запросов.
   - `DB_URL`, `ORGS_CONFIG`, `REVIEWERS_WHITELIST`, `ACCESS_CODES` — при необходимости измените пути/DSN.
3. Папка `config/` содержит примеры организаций и проверяющих; правьте под свои нужды.

## Локальный запуск
```bash
npm install
npm run dev
```

Сервис стартует на `http://localhost:8080`. Основные эндпоинты:
- `POST /webhook/max` — точка входа для апдейтов MAX (должна быть доступна по HTTPS для боевого использования).
- `GET /healthz` — проверка здоровья.

Для продакшен-запуска без авто‑перезапуска используйте:
```bash
npm run start
```

## Docker
1. Сборка образа:
   ```bash
   docker build -t trustline-max .
   ```
2. Запуск контейнера (используем готовый `.env`):
   ```bash
   docker run --env-file .env -p 8080:8080 trustline-max
   ```

Контейнер экспонирует порт `8080`; пробросьте его наружу и убедитесь, что `WEBHOOK_URL` указывает на `https://<домен>/webhook/max`.

## Структура проекта
- `src/config` — загрузка конфигурации и констант (RU‑категории, статусы).
- `src/db` — миграции SQLite и синк с файлами конфигурации.
- `src/services` — работа с кейсами, проверяющими, сессиями, аудитом.
- `src/bot` — обработка апдейтов MAX, клавиатуры, локализация.
- `src/max` — минимальный HTTP‑клиент для Bot API.
- `Dockerfile` — описание контейнерного образа.
- `requirements.txt` — версии всех зависимостей.

## Пример публикации вебхука
После запуска убедитесь, что сервис доступен по адресу, указанному в `WEBHOOK_URL`. MAX можно уведомить автоматически (сервис сделает `setWebhook` при старте) либо вручную через кабинет разработчика. Важно, чтобы значение `WEBHOOK_SECRET` совпадало и на стороне бота, и в настройках MAX.

## Проверка работоспособности
1. Прогоните happy-path из `prdmax.md`: пользователь → организация → категория → текст → отправка → статус.
2. Проверьте, что проверяющий из whitelist’а видит обращения и может менять статусы / писать в обе стороны.
3. Протестируйте запуск контейнера локально и убедитесь, что обращения сохраняются в `data/trustline.db`.
